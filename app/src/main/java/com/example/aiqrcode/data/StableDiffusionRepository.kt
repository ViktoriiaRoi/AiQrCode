package com.example.aiqrcode.data

import android.util.Base64
import com.example.aiqrcode.data.model.ControlNet
import com.example.aiqrcode.data.model.ControlNetArgs
import com.example.aiqrcode.data.model.ImageRequest
import com.example.aiqrcode.data.model.ImageResponse
import com.example.aiqrcode.data.model.Scripts
import com.example.aiqrcode.ui.SetupParams
import com.google.gson.Gson
import okhttp3.MediaType.Companion.toMediaType
import okhttp3.RequestBody.Companion.toRequestBody
import okhttp3.ResponseBody
import retrofit2.Response

interface StableDiffusionRepository {
    suspend fun generateImage(params: SetupParams): Result<ByteArray>
}

class StableDiffusionRepositoryImpl(
    private val imageService: StableDiffusionService
) : StableDiffusionRepository {

    private val gson = Gson()

    override suspend fun generateImage(params: SetupParams): Result<ByteArray> {
        val imageString = "iVBORw0KGgoAAAANSUhEUgAAAwAAAAMACAYAAACTgQCOAAAABHNCSVQICAgIfAhkiAAAIABJREFUeF7t2dGOXLuNBVCfQf33vf5yxQiCAewHNdQsi0VyzVuioya5KE+wUc+///67fvg/AgQIECBAgAABAgRGCPzfiCkNSYAAAQIECBAgQIDAfwUEAA+BAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBAQADwBggQIECAAAECBAgMEhAABi3bqAQIECBAgAABAgQEAG+AAAECBAgQIECAwCABAWDQso1KgAABAgQIECBA4IVgtsA///wzG8D0BAgQIECgoMDPnz8Ldq3lTxHwC8CnbEIfBAgQIECAAAECBC4ICAAXkJUgQIAAAQIECBAg8CkCAsCnbEIfBAgQIECAAAECBC4ICAAXkJUgQIAAAQIECBAg8CkCAsCnbEIfBAgQIECAAAECBC4ICAAXkJUgQIAAAQIECBAg8CkCAsCnbEIfBAgQIECAAAECBC4ICAAXkJUgQIAAAQIECBAg8CkCAsCnbEIfBAgQIECAAAECBC4ICAAXkJUgQIAAAQIECBAg8CkCAsCnbEIfBAgQIECAAAECBC4ICAAXkJUgQIAAAQIECBAg8CkCAsCnbEIfBAgQIECAAAECBC4ICAAXkJUgQIAAAQIECBAg8CkCAsCnbEIfBAgQIECAAAECBC4IvC7UUKKxwPM8jafrP9paq/SQ2e8v6pfdf3T55s/991P9/UTfX/X70X8/1efXf66AXwBy/VUnQIAAAQIECBAgcFVAALjKrRgBAgQIECBAgACBXAEBINdfdQIECBAgQIAAAQJXBQSAq9yKESBAgAABAgQIEMgVEABy/VUnQIAAAQIECBAgcFVAALjKrRgBAgQIECBAgACBXAEBINdfdQIECBAgQIAAAQJXBQSAq9yKESBAgAABAgQIEMgVEABy/VUnQIAAAQIECBAgcFVAALjKrRgBAgQIECBAgACBXAEBINdfdQIECBAgQIAAAQJXBQSAq9yKESBAgAABAgQIEMgVEABy/VUnQIAAAQIECBAgcFVAALjKrRgB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IJApIABk6qtNgAABAgQIECBA4LKAAHAZXDkCBAgQIECAAAECmQICQKa+2gQIECBAgAABAgQuCwgAl8GVI0CAAAECBAgQIJApIABk6qtNgAABAgQIECBA4LKAAHAZXDkCBAgQIECAAAECmQICQKa+2gQIECBAgAABAgQuCwgAl8GVI0CAAAECBAgQIJApIABk6qtNgAABAgQIECBA4LKAAHAZXDkCBAgQIECAAAECmQICQKa+2gQIECBAgAABAgQuC7wu11OOwFsF1lqhv/c8T+h+9HJ2/Wy/aP1s/+z+s+eP1o/6Rf/9ROtH70f9ovez/bLrR/2q7z86v/u1BfwCUHt/uidAgAABAgQIECBwJCAAHHH5mAABAgQIECBAgEBtAQGg9v50T4AAAQIECBAgQOBIQAA44vIxAQIECBAgQIAAgdoCAkDt/emeAAECBAgQIECAwJGAAHDE5WMCBAgQIECAAAECtQUEgNr70z0BAgQIECBAgACBIwEB4IjLxwQIECBAgAABAgRqCwgAtfenewIECBAgQIAAAQJHAgLAEZePCRAgQIAAAQIECNQWEABq70/3BAgQIECAAAECBI4EBIAjLh8TIECAAAECBAgQqC0gANTen+4JECBAgAABAgQIHAkIAEdcPiZAgAABAgQIECBQW0AAqL0/3RMgQIAAAQIECBA4Engdfe1jAh8m8DzPh3V0t521Vqhgdb/o/CG8N1yO+k+fP7qCqH+0fvR+dP/R+9l+0frR+aP7c59ApoBfADL11SZAgAABAgQIECBwWUAAuAyuHAECBAgQIECAAIFMAQEgU19tAgQIECBAgAABApcFBIDL4MoRIECAAAECBAgQyBQQADL11SZAgAABAgQIECBwWUAAuAyuHAECBAgQIECAAIFMAQEgU19tAgQIECBAgAABApcFBIDL4MoRIECAAAECBAgQyBQQADL11SZAgAABAgQIECBwWUAAuAyuHAECBAgQIECAAIFMAQEgU19tAgQIECBAgAABApcFBIDL4MoRIECAAAECBAgQyBQQADL11SZAgAABAgQIECBwWUAAuAyuHAECBAgQIECAAIFMAQEgU19tAgQIECBAgAABApcFXpfrKUfgN4HneUIia63Q/eqXp/tVnz/6fqPzR99/tP9o/enzR/2i96P7j+4vWj86f/X+o/O7X1vALwC196d7AgQI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RPTcJUCAAAECBAgQIFBMQAAotjDtEiBAgAABAgQIEIgICAARPXcJECBAgAABAgQIFBN4FetXuwR+E3iep7TIWqt0/9n+0fpR/+j97P6j9bMfr/6zNxCrH/33E6v+40d2/Wj/7hOICPgFIKLnLgECBAgQIECAAIFiAgJAsYVplwABAgQIECBAgEBEQACI6LlLgAABAgQIECBAoJiAAFBsYdolQIAAAQIECBAgEBEQACJ67hIgQIAAAQIECBAoJiAAFFuYdgkQIECAAAECBAhEBASAiJ67BAgQIECAAAECBIoJCADFFqZdAgQIECBAgAABAhEBASCi5y4BAgQIECBAgACBYgICQLGFaZcAAQIECBAgQIBAREAAiOi5S4AAAQIECBAgQKCYgABQbGHaJUCAAAECBAgQIBAREAAieu4SIECAAAECBAgQKCYgABRbmHYJECBAgAABAgQIRAQEgIieuwQIECBAgAABAgSKCbyK9atdAgQI/L/AWiuk8TxP6H70crT/aP3p96f7R99/db/p80//9z99fr8ATH8B5idAgAABAgQIEBglIACMWrdhCRAgQIAAAQIEpgsIANNfgPkJECBAgAABAgRGCQgAo9ZtWAIECBAgQIAAgekCAsD0F2B+AgQIECBAgACBUQICwKh1G5YAAQIECBAgQGC6gAAw/QWYnwABAgQIECBAYJSAADBq3YYlQIAAAQIECBCYLiAATH8B5idAgAABAgQIEBglIACMWrdhCRAgQIAAAQIEpgsIANNfgPkJECBAgAABAgRGCQgAo9ZtWAIECBAgQIAAgekCAsD0F2B+AgQIECBAgACBUQICwKh1G5YAAQIECBAgQGC6gAAw/QWYnwABAgQIECBAYJTAa9S0hiVA4K0Ca63Q33ueJ3Q/ejnaf7R+dP5o/9H70f6j96P+0fvZ/Uf3lz1/dv/mjwq4X1nALwCVt6d3AgQIECBAgAABAocCAsAhmM8JECBAgAABAgQIVBYQACpvT+8ECBAgQIAAAQIEDgUEgEMwnxMgQIAAAQIECBCoLCAAVN6e3gkQIECAAAECBAgcCggAh2A+J0CAAAECBAgQIFBZQACovD29EyBAgAABAgQIEDgUEAAOwXxOgAABAgQIECBAoLKAAFB5e3onQIAAAQIECBAgcCggAByC+ZwAAQIECBAgQIBAZQEBoPL29E6AAAECBAgQIEDgUEAAOATzOQECBAgQIECAAIHKAgJA5e3pnQABAgQIECBAgMChgABwCOZzAgQIECBAgAABApUFBIDK29M7AQIECBAgQIAAgUOB1+H3PifwUQJrrY/qRzNnAvZ35vXn18/z/PlfXf3P2furPn+0/+j96P6i9aP3o489e/5o/+4TiAj4BSCi5y4BAgQIECBAgACBYgICQLGFaZcAAQIECBAgQIBAREAAiOi5S4AAAQIECBAgQKCYgABQbGHaJUCAAAECBAgQIBAREAAieu4SIECAAAECBAgQKCYgABRbmHYJECBAgAABAgQIRAQEgIieuwQIECBAgAABAgSKCQgAxRamXQIECBAgQIAAAQIRAQEgoucuAQIECBAgQIAAgWICAkCxhWmXAAECBAgQIECAQERAAIjouUuAAAECBAgQIECgmIAAUGxh2iVAgAABAgQIECAQERAAInruEiBAgAABAgQIECgmIAAUW5h2CRAgQIAAAQIECEQEBICInrsECBAgQIAAAQIEigm8ivWr3WYCz/M0m8g4NwWi72etFWo3u36o+Tdcjs7/hhZCf6J6/9nvN4T/63K0/2j96P3q/Ufnd7+2gF8Aau9P9wQIECBAgAABAgSOBASAIy4fEyBAgAABAgQIEKgtIADU3p/uCRAgQIAAAQIECBwJCABHXD4mQIAAAQIECBAgUFtAAKi9P90TIECAAAECBAgQOBIQAI64fEyAAAECBAgQIECgtoAAUHt/uidAgAABAgQIECBwJCAAHHH5mAABAgQIECBAgEBtAQGg9v50T4AAAQIECBAgQOBIQAA44vIxAQIECBAgQIAAgdoCAkDt/emeAAECBAgQIECAwJGAAHDE5WMCBAgQIECAAAECtQUEgNr70z0BAgQIECBAgACBIwEB4IjLxwQIECBAgAABAgRqCwgAtfenewIECBAgQIAAAQJHAq+jr31M4A+BtRYTAmkC2e8vu34a/P8KT58/2z9a3/6igu4TqCvgF4C6u9M5AQIECBAgQIAAgWMBAeCYzAUCBAgQIECAAAECdQUEgLq70zkBAgQIECBAgACBYwEB4JjMBQIECBAgQIAAAQJ1BQSAurvTOQECBAgQIECAAIFjAQHgmMwFAgQIECBAgAABAnUFBIC6u9M5AQIECBAgQIAAgWMBAeCYzAUCBAgQIECAAAECdQUEgLq70zkBAgQIECBAgACBYwEB4JjMBQIECBAgQIAAAQJ1BQSAurvTOQECBAgQIECAAIFjAQHgmMwFAgQIECBAgAABAnUFBIC6u9M5AQIECBAgQIAAgWMBAeCYzAUCBAgQIECAAAECdQUEgLq70zkBAgQIECBAgACBY4HX8Q0XWgn8/Pmz1TyGIUCAAAECBAgQ2Av4BWDv45QAAQIECBAgQIBAKwEBoNU6DUOAAAECBAgQIEBgLyAA7H2cEiBAgAABAgQIEGglIAC0WqdhCBAgQIAAAQIECOwFBIC9j1MCBAgQIECAAAECrQQEgFbrNAwBAgQIECBAgACBvYAAsPdxSoAAAQIECBAgQKCVgADQap2GIUCAAAECBAgQILAXEAD2Pk4JECBAgAABAgQItBIQAFqt0zAECBAgQIAAAQIE9gICwN7HKQECBAgQIECAAIFWAgJAq3UahgABAgQIECBAgMBeQADY+zglQIAAAQIECBAg0EpAAGi1TsMQIECAAAECBAgQ2AsIAHsfpwQIECBAgAABAgRaCQgArdZpGAIECBAgQIAAAQJ7AQFg7+OUAAECBAgQIECAQCsBAaDVOg1DgAABAgQIECBAYC8gAOx9nBIgQIAAAQIECBBoJSAAtFqnYQgQIECAAAECBAjsBQSAvY9TAgQIECBAgAABAq0EBIBW6zQMAQIECBAgQIAAgb2AALD3cUqAAAECBAgQIECglYAA0GqdhiFAgAABAgQIECCwFxAA9j5OCRAgQIAAAQIECLQSEABardMwBAgQIECAAAECBPYCAsDexykBAgQIECBAgACBVgICQKt1GoYAAQIECBAgQIDAXkAA2Ps4JUCAAAECBAgQINBKQABotU7DECBAgAABAgQIENgLCAB7H6cECBAgQIAAAQIEWgkIAK3WaRgCBAgQIECAAAECewEBYO/jlAABAgQIECBAgEArAQGg1ToNQ4AAAQIECBAgQGAvIADsfZwSIECAAAECBAgQaCUgALRap2EIECBAgAABAgQI7AUEgL2PUwIECBAgQIAAAQKtBASAVus0DAECBAgQIECAAIG9gACw93FKgAABAgQIECBAoJWAANBqnYYhQIAAAQIECBAgsBcQAPY+TgkQIECAAAECBAi0EhAAWq3TMAQIECBAgAABAgT2AgLA3scpAQIECBAgQIAAgVYCAkCrdRqGAAECBAgQIECAwF5AANj7OCVAgAABAgQIECDQSkAAaLVOwxAgQIAAAQIECBDYCwgAex+nBAgQIECAAAECBFoJCACt1mkYAgQIECBAgAABAnsBAWDv45QAAQIECBAgQIBAKwEBoNU6DUOAAAECBAgQIEBgLyAA7H2cEiBAgAABAgQIEGglIAC0WqdhCBAgQIAAAQIECOwFBIC9j1MCBAgQIECAAAECrQQEgFbrNAwBAgQIECBAgACBvYAAsPdxSoAAAQIECBAgQKCVgADQap2GIUCAAAECBAgQILAXEAD2Pk4JECBAgAABAgQItBIQAFqt0zAECBAgQIAAAQIE9gICwN7HKQECBAgQIECAAIFWAgJAq3UahgABAgQIECBAgMBeQADY+zglQIAAAQIECBAg0EpAAGi1TsMQIECAAAECBAgQ2AsIAHsfpwQIECBAgAABAgRaCQgArdZpGAIECBAgQIAAAQJ7AQFg7+OUAAECBAgQIECAQCsBAaDVOg1DgAABAgQIECBAYC8gAOx9nBIgQIAAAQIECBBoJSAAtFqnYQgQIECAAAECBAjsBQSAvY9TAgQIECBAgAABAq0EBIBW6zQMAQIECBAgQIAAgb2AALD3cUqAAAECBAgQIECglYAA0GqdhiFAgAABAgQIECCwFxAA9j5OCRAgQIAAAQIECLQSEABardMwBAgQIECAAAECBPYCAsDexykBAgQIECBAgACBVgICQKt1GoYAAQIECBAgQIDAXkAA2Ps4JUCAAAECBAgQINBKQABotU7DECBAgAABAgQIENgLCAB7H6cECBAgQIAAAQIEWgkIAK3WaRgCBAgQIECAAAECewEBYO/jlAABAgQIECBAgEArAQGg1ToNQ4AAAQIECBAgQGAvIADsfZwSIECAAAECBAgQaCUgALRap2EIECBAgAABAgQI7AUEgL2PUwIECBAgQIAAAQKtBASAVus0DAECBAgQIECAAIG9gACw93FKgAABAgQIECBAoJWAANBqnYYhQIAAAQIECBAgsBcQAPY+TgkQIECAAAECBAi0EhAAWq3TMAQIECBAgAABAgT2AgLA3scpAQIECBAgQIAAgVYCAkCrdRqGAAECBAgQIECAwF5AANj7OCVAgAABAgQIECDQSkAAaLVOwxAgQIAAAQIECBDYCwgAex+nBAgQIECAAAECBFoJCACt1mkYAgQIECBAgAABAnsBAWDv45QAAQIECBAgQIBAKwEBoNU6DUOAAAECBAgQIEBgLyAA7H2cEiBAgAABAgQIEGglIAC0WqdhCBAgQIAAAQIECOwFBIC9j1MCBAgQIECAAAECrQQEgFbrNAwBAgQIECBAgACBvYAAsPdxSoAAAQIECBAgQKCVgADQap2GIUCAAAECBAgQILAXEAD2Pk4JECBAgAABAgQItBIQAFqt0zAECBAgQIAAAQIE9gICwN7HKQECBAgQIECAAIFWAgJAq3UahgABAgQIECBAgMBeQADY+zglQIAAAQIECBAg0EpAAGi1TsMQIECAAAECBAgQ2AsIAHsfpwQIECBAgAABAgRaCQgArdZpGAIECBAgQIAAAQJ7AQFg7+OUAAECBAgQIECAQCsBAaDVOg1DgAABAgQIECBAYC8gAOx9nBIgQIAAAQIECBBoJSAAtFqnYQgQIECAAAECBAjsBQSAvY9TAgQIECBAgAABAq0EBIBW6zQMAQIECBAgQIAAgb2AALD3cUqAAAECBAgQIECglYAA0GqdhiFAgAABAgQIECCwFxAA9j5OCRAgQIAAAQIECLQSEABardMwBAgQIECAAAECBPYCAsDexykBAgQIECBAgACBVgICQKt1GoYAAQIECBAgQIDAXkAA2Ps4JUCAAAECBAgQINBKQABotU7DECBAgAABAgQIENgLCAB7H6cECBAgQIAAAQIEWgkIAK3WaRgCBAgQIECAAAECewEBYO/jlAABAgQIECBAgEArAQGg1ToNQ4AAAQIECBAgQGAvIADsfZwSIECAAAECBAgQaCUgALRap2EIECBAgAABAgQI7AUEgL2PUwIECBAgQIAAAQKtBASAVus0DAECBAgQIECAAIG9gACw93FKgAABAgQIECBAoJWAANBqnYYhQIAAAQIECBAgsBcQAPY+TgkQIECAAAECBAi0EhAAWq3TMAQIECBAgAABAgT2AgLA3scpAQIECBAgQIAAgVYCAkCrdRqGAAECBAgQIECAwF5AANj7OCVAgAABAgQIECDQSkAAaLVOwxAgQIAAAQIECBDYCwgAex+nBAgQIECAAAECBFoJ/Ae+DUQ2nIbjjgAAAABJRU5ErkJggg=="
        val imageRequest = createImageRequest(
            prompt = params.prompt,
            image = imageString,
            weight = 1.8f
        )
        val mediaType = "application/json".toMediaType()
        val requestBody = gson.toJson(imageRequest).toRequestBody(mediaType)

        return try {
            val response = imageService.generateImage(requestBody)
            processResponse(response)
        } catch (e: Exception) {
            Result.failure(e)
        }
    }

    private fun processResponse(response: Response<ResponseBody>): Result<ByteArray> {
        val body = response.body()
        if (response.isSuccessful && body != null) {
            val decoded = decodeImage(body.string())
            return decoded?.let {
                Result.success(decoded)
            } ?: Result.failure(Exception("Failed to decode image"))
        } else {
            return Result.failure(Exception("Unsuccessful network call: ${response.message()}"))
        }
    }

    private fun decodeImage(jsonString: String): ByteArray? {
        val imageResponse = gson.fromJson(jsonString, ImageResponse::class.java)
        return imageResponse.images.firstOrNull()?.let {
            Base64.decode(it, Base64.DEFAULT)
        }
    }

    private fun createImageRequest(prompt: String, image: String, weight: Float) =
        ImageRequest(
            prompt = prompt,
            negative_prompt = "ugly, disfigured, low quality, blurry, nsfw",
            width = 512,
            height = 512,
            steps = 10,
            alwayson_scripts = Scripts(
                controlnet = ControlNet(
                    args = listOf(
                        ControlNetArgs(
                            input_image = image,
                            model = "control_v1p_sd15_qrcode_monster_v2 [5e5778cb]",
                            weight = weight
                        )
                    )
                )
            )
        )
}